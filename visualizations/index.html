<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MinnPost</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link type="text/css" rel="stylesheet" media="all" href="http://www.minnpost.com/sites/default/files/css/css_bb801627df93671ec2cf2a1c9ecf4ad2.css" />
  <link type="text/css" rel="stylesheet" media="screen" href="http://www.minnpost.com/sites/default/files/css/css_b833827e9fdb99e83e393d38c32a71fd.css" />
  <link type="text/css" rel="stylesheet" media="print" href="http://www.minnpost.com/sites/default/files/css/css_dd48b5b093a35515052acfc42613d628.css" />
  <!--[if IE]>
      <link rel="stylesheet" href="http://www.minnpost.com/sites/default/themes/derma/inc/css/ie.css?j" type="text/css">
  <![endif]-->
  <meta name="viewport" content="width=device-width, initial-scale=1"></meta>
</head>
<body class="front logged-in page-home one-sidebar sidebar-right admin-nw admin-vertical admin-df  one-sidebar sidebar-right">


  <!-- Embed Start -->
  <div class="node-body fieldlayout node-field-body">
    <style type="text/css">
      @import url('http://data.minnpost.s3.amazonaws.com/js/leaflet-0.3.1/leaflet.css');
    </style>
    <!--[if lte IE 8]>
      <style type="text/css">
        @import url('http://data.minnpost.s3.amazonaws.com/js/leaflet-0.3.1/leaflet.ie.css');
      </style>
    <![endif]-->
    <style type="text/css">
      .js-dependent,
      .hide {
        display: none;
      }
      
      .footnote {
        font-size: .75em;
        font-style: italic;
        color: #414141;
        margin-top: 1em;
      }
      
      #map {
        width: 100%;
        height: 550px;
      }
      
      /** Media queries **/
      @media all and (max-width: 750px) {
      }
    </style>
    
    <div id="map"></div>
    
    <div class="loading"></div>
    <div class="time_day"></div>
    <div class="controls">
      <a href="#play" class="play">Play</a>
      <a href="#pause" class="pause">Pause</a>
    </div>
    
    <p class="footnote"></p>
  
    <script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/jquery-1.7.2/jquery-1.7.2.min.js"><\/script>')</script>
    
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/leaflet-0.3.1/leaflet.js"></script>
    <script type="text/javascript" src="https://s3.amazonaws.com/data.minnpost/js/berniecode-animator-20120521/animator.min.js"></script>
    <script type="text/javascript">
      // Converts numeric degrees to radians
      if (typeof(Number.prototype.toRad) === "undefined") {
        Number.prototype.toRad = function() {
          return this * Math.PI / 180;
        }
      }
      // Converts radians to numeric (signed) degrees
      if (typeof(Number.prototype.toDeg) === "undefined") {
        Number.prototype.toDeg = function() {
          return this * 180 / Math.PI;
        }
      }
    
      // Object for dealing with map data
      var mapExtender = {};
      mapExtender.lineDistance = function(line) {
        // Get distance of geojson object
        var dist = 0;
        
        if (typeof line.type != 'undefined' && line.type == 'LineString') {
          for (var i = 1; i < line.coordinates.length; i++) {
            dist += mapExtender.coordDistance(line.coordinates[i], line.coordinates[i - 1]);
          }
          
          return dist;
        }
        else {
          return dist;
        }
      };
      mapExtender.coordDistance = function(coord1, coord2) {
        // Get Haversine distance between two Geojson coordinates
        var dLat = (coord2[1] - coord1[1]).toRad();
        var dLon = (coord2[0] - coord1[0]).toRad();
        var lat1 = coord1[1].toRad();
        var lat2 = coord2[1].toRad();
        
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return c;
      };
      mapExtender.coordAtDistance = function(line, dist) {
        // Gets coordinate at specific place along path
        var coord = [];
        var distCurrent = 0;
        var distOld = 0;
        
        // If 0, then just give the first coordinate back.
        if (dist == 0) {
          return line.coordinates[0];
        }

        // Got to each coordinate and check if we need to go to next;
        for (var i = 1; (i < line.coordinates.length && distCurrent < dist); i++) {
          distOld = distCurrent;
          distCurrent += mapExtender.coordDistance(line.coordinates[i], line.coordinates[i - 1]);
        }
        
        // Check if we did not make it
        if (distCurrent < dist) {
          return coord;
        }
        var p1 = line.coordinates[i - 2];
        var p2 = line.coordinates[i - 1];
        var part = (dist - distOld) / (distCurrent - distOld);

        // Lon
        coord[0] = p1[0] + (p2[0] - p1[0]) * part;
        coord[1] = p1[1] + (p2[1] - p1[1]) * part;
        return coord;
      }
      mapExtender.toKM = function(v) {
        // Returns KM from a lat/lon distance;
        return v * 6371;
      };
      mapExtender.toM = function(v) {
        // Returns M from a lat/lon distance;
        return v * 6371 * 1000;
      };
      
      // Object for dealing with time
      var timeExtender = {};
      timeExtender.secondsToTime = function(secs) {
        var hours = Math.floor(secs / (60 * 60));
        var divisor_for_minutes = secs % (60 * 60);
        var minutes = Math.floor(divisor_for_minutes / 60);
        var seconds = Math.ceil(divisor_for_minutes % 60);
        
        return {
          'h': hours,
          'm': minutes,
          's': seconds
        };
      };
      
      // Namespace jQuery
      (function($) {
        $(document).ready(function() {
          $('.loading').html('Loading map..');
          
          // Start map
          var map = new L.Map('map', { maxZoom: 15, minZoom: 8 });
          
        	// Minnnpost base map
        	minnpost = new L.TileLayer('http://{s}.tiles.minnpost.com/minnpost-basemaps/minnpost-minnesota-greyscale-no-labels/{z}/{x}/{y}.png', 
        	 { attribution: 'Map imagery from <a target="_blank" href="http://minnpost.com">MinnPost</a>; Map data from <a target="_blank" href="http://openstreetmap.org">OpenStreetMap</a>.',
            scheme: 'tms' });
        	map.addLayer(minnpost);
        	
        	// Route layer
          routes = new L.TileLayer('http://{s}.tiles.minnpost.com/minnpost-nice-ride/minnpost-nice-ride-routes/{z}/{x}/{y}.png', 
            { attribution: 'Data provided by <a target="_blank" href="https://www.niceridemn.org/">Nice Ride MN</a>; ',
            scheme: 'tms' });
          map.addLayer(routes);
          
          // Labels
        	minnpost_l = new L.TileLayer('http://{s}.tiles.minnpost.com/minnpost-basemaps/minnpost-minnesota-greyscale-labels/{z}/{x}/{y}.png', 
        	 { scheme: 'tms' });
        	map.addLayer(minnpost_l);
        	
        	// Set view
          map.setView(new L.LatLng(44.9745, -93.2513), 13);
          
          // A place for animations, rentals, and routes.  (seekFromTo(0.25, 0.75))
          var animations = {};
          var rentals_loaded = {};
          var routes_loaded = {};
          
          // Callback once animations and routes have been loaded.
          var loadAnimations = function() {
            // Time in seconds
            var time_day = 24 * 60 * 60;
            var time_anim = 2 * 60; // 20 minute animation
            var time_ratio = time_anim / time_day;
            var anim_date = { // 2011-05-18
              'y': 2011,
              'm': 4,
              'd': 18
            };
            var day_offset = ((4 * 60) + 30) * 60; // 4:30
            
            // Animation options
            var anim_interval = 100;
            var circleOptions = {
              stroke: false,
              fillColor: '#10517F',
              fillOpacity: 0.98,
              clickable: false,
              radius: 8
            };
          
            // Create each animation up front.
            var i;
            for (i in rentals_loaded) {
              // TODO: Not taking into account X to X routes
              if (typeof routes_loaded[rentals_loaded[i].st + '-' + rentals_loaded[i].et] != 'undefined') {
                var closureAnimation = (function(rent, rout) {
                  return function() {
                    // Time should be in milliseconds
                    var time = rent.d * time_ratio * 1000;
                    var d = mapExtender.lineDistance(rout.r);
                    var marker = new L.CircleMarker(new L.LatLng(0, 0), circleOptions);

                    map.addLayer(marker);
                    animation = new Animator({
                      duration: time,
                      interval: anim_interval,
                      transition: Animator.tx.linear,
                      onComplete: function() {
                        // As stop will call this as well, check for state
                        if (this.state == 1) {
                          map.removeLayer(marker);
                        }
                      }
                    });
                    function animateMarker(interval) {
                      var dist = interval * d;
                      var coord = mapExtender.coordAtDistance(rout.r, dist);
                      marker.setLatLng(new L.LatLng(coord[1], coord[0]));
                    };
                    animation.addSubject(animateMarker);

                    // Add some meta data
                    animation.st = rent.s;
                    animation.en = rent.e;
                    animation.dur = rent.d;
                    
                    return animation;
                  }
                })(rentals_loaded[i], routes_loaded[rentals_loaded[i].st + '-' + rentals_loaded[i].et]);
                
                animations[i] = closureAnimation();
              }
            }
            $('.loading').html('loaded rentals.  loaded routes.  loaded animations.');
            
            // Cleanup
            delete rentals_loaded;
            delete routes_loaded;
            
            // Create day animation to fire off different events
            var day = new Animator({
              duration: time_anim * 1000,
              interval: anim_interval,
              transition: Animator.tx.linear,
              onComplete: function() {
                // Shown when stopped as well as complete.
              }
            });
            var handleDay = function(interval) {
              // Determine the time of day it is in the animation
              var totalSecElapsed = interval * time_day + day_offset;
              var timeObj = timeExtender.secondsToTime(totalSecElapsed);
              var currentTime = new Date(anim_date.y, anim_date.m, anim_date.d, timeObj.h, timeObj.m, timeObj.s);
              var a;

              // Show time
              $('.time_day').html(currentTime.toTimeString());
              
              // Find any animations that have not been played yet
              // that start before now and end after now.  Animation 
              // state is between 0 and 1.
              for (a in animations) {
                var animateStart = new Date(animations[a].st);
                var animateEnd = new Date(animations[a].en);
                if (animateStart <= currentTime && animateEnd > currentTime && animations[a].state == 0) {
                  animations[a].play();
                }
              }
            };
            day.addSubject(handleDay);
            
            // Animation controls
            $('.play').click(function(e) {
              e.preventDefault();
              day.seekTo(1);
              // Start all already started animations
              for (a in animations) {
                if (animations[a].state > 0 && animations[a].state < 1) {
                  animations[a].seekTo(1);
                }
              }
            });
            $('.pause').click(function(e) {
              e.preventDefault();
              day.stop();
              // Pause all animations.  Sometimes this misses??
              for (a in animations) {
                if (animations[a].state > 0 && animations[a].state < 1) {
                  animations[a].stop();
                }
              }
            });
          };
          
          // Call back for routes
          callback_routes = function(routes) {
            $('.loading').html('loaded rentals.  loaded routes.  loading animations.');
            routes_loaded = routes;
            loadAnimations();
          };
          
          // Call back for rentals
          callback_rentals = function(rentals) {
            $('.loading').html('loaded rentals.  loading routes..');
            rentals_loaded = rentals;
            $.ajax({
              type: 'GET',
              dataType: 'jsonp',
              url: 'data/routes.jsonp?callback=callback_routes',
              jsonp: 'callback'
            });
          };
          
          // Load data
          $.ajax({
            type: 'GET',
            dataType: 'jsonp',
            url: 'data/rentals.jsonp?callback=callback_rentals',
            jsonp: 'callback'
          });
        });
      })(jQuery);
    </script>
  </div>
  <!-- Embed End -->


</body>
</html>